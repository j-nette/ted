{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
  <title>Ted Voice Chat</title>
    <style>
    .bear-paw {
      width: 40px;
      height: 40px;
      background-color: #8d6e63;
      border-radius: 50%;
      position: absolute;
      bottom: -20px;
      right: -20px;
      transform: rotate(-20deg);
      opacity: 0;
      transition: all 0.3s ease;
    }
    /* Listening state styles */
    .listening .bear-mouth {
      width: 20px;
      height: 10px;
      border-radius: 0;
      transform: rotate(-10deg);
    }
    .listening .bear-paw {
      opacity: 1;
      transform: rotate(-30deg) translate(-10px, -10px);
    }
    .microphone-container {
      position: relative;
      width: 80px;
      height: 80px;
      margin-top: auto;
      margin-bottom: 40px;
    }
    .microphone-button {
      width: 100%;
      height: 100%;
      border: none;
      background: none;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }
    .microphone-icon {
      width: 40px;
      height: 40px;
      background-color: #000;
      border-radius: 50%;
      position: relative;
      margin: 20px;
    }
    .microphone-icon::before {
      content: '';
      position: absolute;
      width: 4px;
      height: 20px;
      background-color: #000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      border-radius: 2px;
    }
    .microphone-icon::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 4px;
      background-color: #000;
      left: 50%;
      bottom: 5px;
      transform: translateX(-50%);
      border-radius: 2px;
    }
    .microphone-rings {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 2px solid #ff4444;
      border-radius: 50%;
      opacity: 0;
    }
    .ring-1 { width: 50px; height: 50px; }
    .ring-2 { width: 65px; height: 65px; }
    .ring-3 { width: 80px; height: 80px; }
    /* Animation for the rings */
    @keyframes ripple {
      0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0;
      }
    }
    .listening .ring-1 { animation: ripple 2s infinite 0s; }
    .listening .ring-2 { animation: ripple 2s infinite 0.3s; }
    .listening .ring-3 { animation: ripple 2s infinite 0.6s; }
  </style>
</head>
<body>
  <div>
    <h1 class="title">Listening</h1>
    <div class="phone-container">
      <div class="status-bar">
        <div class="time">9:30 PM</div>
        <div class="icons">
          <div class="signal">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M4 16L4 20" stroke="black" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 12L8 20" stroke="black" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 8L12 20" stroke="black" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 4L16 20" stroke="black" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="wifi">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 19.5H12.01" stroke="black" stroke-width="3" stroke-linecap="round"/>
              <path d="M8 15C9.06087 13.9391 10.5304 13.3258 12 13.3258C13.4696 13.3258 14.9391 13.9391 16 15" stroke="black" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 11C6.38695 8.61305 9.53912 7.32581 12 7.32581C14.4609 7.32581 17.613 8.61305 20 11" stroke="black" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="battery">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <rect x="2" y="7" width="18" height="10" rx="2" stroke="black" stroke-width="2"/>
              <path d="M20 11H22V13H20V11Z" fill="black"/>
              <rect x="4" y="9" width="14" height="6" fill="black"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="app-content">
        <div class="decorative-shape"></div>
        <div class="decorative-shape-2"></div>
        
        <div class="bear-container" id="bear-container">
          <div class="bear">
            <div class="bear-ear-left">
              <div class="bear-ear-inner-left"></div>
            </div>
            <div class="bear-ear-right">
              <div class="bear-ear-inner-right"></div>
            </div>
            <div class="bear-face">
              <div class="bear-eye-left"></div>
              <div class="bear-eye-right"></div>
              <div class="bear-muzzle">
                <div class="bear-nose"></div>
                <div class="bear-mouth"></div>
              </div>
              <div class="bear-paw"></div>
            </div>
          </div>
        </div>
  
        <div class="microphone-container">
          <button class="microphone-button" id="microphone-button">
            <div class="microphone-icon"></div>
          </button>
          <div class="microphone-rings">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Function to retrieve the CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    document.addEventListener('DOMContentLoaded', function() {
      const micButton = document.getElementById('microphone-button');
      const container = document.querySelector('.phone-container');
      let mediaRecorder;
      let isRecording = false;
  
      // Request microphone access and set up recording
      async function setupMicrophone() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
  
          mediaRecorder.ondataavailable = function(e) {
            const audioBlob = e.data;
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav'); // Ensure file format matches what your view expects
  
            fetch('/voice/', { // Adjust the URL if necessary
              method: 'POST',
              headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              console.log('Transcription:', data.transcription);
              // Optionally update your UI with the transcription
            })
            .catch(err => console.error('Error:', err));
          };
  
          return true;
        } catch (err) {
          console.error('Error accessing microphone:', err);
          return false;
        }
      }
  
      // Toggle recording state
      async function toggleRecording() {
        if (!mediaRecorder) {
          const setup = await setupMicrophone();
          if (!setup) return;
        }
  
        if (!isRecording) {
          mediaRecorder.start();
          container.classList.add('listening');
        } else {
          mediaRecorder.stop();
          container.classList.remove('listening');
        }
  
        isRecording = !isRecording;
      }
  
      micButton.addEventListener('click', toggleRecording);
    });
  </script>
</body>
</html>
